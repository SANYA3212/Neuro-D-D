<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Neuro D&D ‚Äî –æ–¥–∏–Ω —Ñ–∞–π–ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary:#ff4500; --secondary:#8b0000; --background:#000000;
    }
    .dark body{ background-color:var(--background); }
    /* Simple scrollbar for webkit browsers */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--secondary); }
  </style>
</head>
<body class="min-h-screen text-white">
  <div id="app"></div>
  <div id="modals"></div>

  <script>
    // ====== –£—Ç–∏–ª–∏—Ç—ã ======
    const qs = (sel, root = document) => root.querySelector(sel);
    const qsa = (sel, root = document) => root.querySelectorAll(sel);

    // ====== –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ======
    const state = {
      currentPage: 'landing',
      user: null,
      campaigns: [],
      currentCampaign: null,
      currentRoom: null,
      initiativeOrder: [],
      sceneHistory: [],
      diceRoll: null,
      isRolling: false,
      isMuted: false,
      isMicrophoneActive: false,
      theme: 'dark',
      language: 'ru',
      customTheme: { primary: '#ff4500', secondary: '#8b0000', background: '#000000' },
      chatMessages: [],
      lobbyReady: false,
      pollingIntervalId: null,
    };

    // ====== –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏ API ======
    const storage = {
      getUserCode: () => localStorage.getItem('user_code'),
      saveUserCode: (code) => localStorage.setItem('user_code', code),
      removeUserCode: () => localStorage.removeItem('user_code'),
    };

    const api = {
      BASE_URL: '/api',
      async fetchJSON(path, options = {}) {
        const url = this.BASE_URL + path;
        const headers = { ...options.headers };
        const userCode = storage.getUserCode();
        if (userCode) {
          headers['X-User-Code'] = userCode;
        }
        if (options.body) {
          headers['Content-Type'] = 'application/json';
          options.body = JSON.stringify(options.body);
        }
        try {
          const response = await fetch(url, { ...options, headers });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: response.statusText }));
            throw new Error(errorData.detail || 'Unknown server error');
          }
          if (response.status === 204) return null;
          return response.json();
        } catch (error) {
          console.error(`API Error on ${path}:`, error);
          // TODO: Show user-friendly error message
          throw error;
        }
      },
      register: (username, email, password) => api.fetchJSON('/auth/register', { method: 'POST', body: { username, email, password } }),
      login: (email, password) => api.fetchJSON('/auth/login', { method: 'POST', body: { email, password } }),
      getMe: () => api.fetchJSON('/auth/me'),
      getCampaigns: () => api.fetchJSON('/campaigns'),
      updateProfile: (username) => api.fetchJSON('/users/profile', { method: 'PUT', body: { username } }),
      updateAvatar: (avatar_url) => api.fetchJSON('/users/profile', { method: 'PUT', body: { avatar_url } }),
      getAiCompletion: (payload) => api.fetchJSON('/ai/complete', { method: 'POST', body: payload }),
      createRoom: (isPublic, name) => api.fetchJSON('/rooms', { method: 'POST', body: { is_public: isPublic, name: name } }),
      joinRoom: (roomCode) => api.fetchJSON('/rooms/join', { method: 'POST', body: { room_code: roomCode } }),
      getRoomDetails: (roomCode) => api.fetchJSON(`/rooms/${roomCode}`),
      createCampaign: (name, tone, difficulty) => api.fetchJSON('/campaigns', { method: 'POST', body: { name, tone, difficulty } }),
      deleteCampaign: (campaignId) => api.fetchJSON(`/campaigns/${campaignId}`, { method: 'DELETE' }),
      saveSettings: (settings) => api.fetchJSON('/users/settings', { method: 'PUT', body: settings }),
    };

    // ====== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è ======
    const translations = {
      ru: { newGame:"–ù–æ–≤–∞—è –∏–≥—Ä–∞", joinRoom:"–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É", continue:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", setPlot:"–ó–∞–¥–∞—Ç—å —Å—é–∂–µ—Ç", settings:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏", howToPlay:"–ö–∞–∫ –∏–≥—Ä–∞—Ç—å", profile:"–ü—Ä–æ—Ñ–∏–ª—å", logout:"–í—ã–π—Ç–∏", createRoom:"–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É", joinByCode:"–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –ø–æ –∫–æ–¥—É", publicRooms:"–ü—É–±–ª–∏—á–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã", noSavedCampaigns:"–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π", startNewGame:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É", campaignName:"–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏", tone:"–¢–æ–Ω –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è", difficulty:"–°–ª–æ–∂–Ω–æ—Å—Ç—å", players:"–ò–≥—Ä–æ–∫–∏", host:"–•–æ—Å—Ç", ready:"–ì–æ—Ç–æ–≤", notReady:"–ù–µ –≥–æ—Ç–æ–≤", startGame:"–ù–∞—á–∞—Ç—å –∏–≥—Ä—É", saveCheckpoint:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ–∫–ø–æ–∏–Ω—Ç", back:"–ù–∞–∑–∞–¥", sceneDescription:"–û–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã", chat:"–ß–∞—Ç", journal:"–ñ—É—Ä–Ω–∞–ª", rollD20:"–ë—Ä–æ—Å–∏—Ç—å d20", mute:"–û—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫", unmute:"–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫", microphoneOn:"–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω", microphoneOff:"–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω", themeSettings:"–¢–µ–º—ã", languageSettings:"–Ø–∑—ã–∫", darkTheme:"–¢–µ–º–Ω–∞—è —Ç–µ–º–∞", lightTheme:"–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞", customTheme:"–ö–∞—Å—Ç–æ–º–Ω–∞—è —Ç–µ–º–∞", apply:"–ü—Ä–∏–º–µ–Ω–∏—Ç—å", cancel:"–û—Ç–º–µ–Ω–∞", enterRoomCode:"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã", join:"–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è", public:"–ü—É–±–ª–∏—á–Ω–∞—è", private:"–ü—Ä–∏–≤–∞—Ç–Ω–∞—è", campaignSettings:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–ø–∞–Ω–∏–∏", gameReady:"–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?", aiGenerating:"–ù–µ–π—Ä–æ—Å–µ—Ç—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç...", login:"–í–æ–π—Ç–∏", register:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", email:"Email", password:"–ü–∞—Ä–æ–ª—å", confirmPassword:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å", rememberMe:"–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è", forgotPassword:"–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?", createAccount:"–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç", alreadyHaveAccount:"–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?", needAccount:"–ù—É–∂–µ–Ω –∞–∫–∫–∞—É–Ω—Ç?", loginWith:"–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑", registerWith:"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑", send:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å", easy:"–õ–µ–≥–∫–∞—è", medium:"–°—Ä–µ–¥–Ω—è—è", hard:"–°–ª–æ–∂–Ω–∞—è", gamesPlayed:"–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ", hoursPlayed:"–ß–∞—Å–æ–≤ –∏–≥—Ä—ã", achievements:"–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è", recentCampaigns:"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏", welcomeBack:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ", createYourAccount:"–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç", or:"–∏–ª–∏", rolled:"–±—Ä–æ—Å–∏–ª", error:"–û—à–∏–±–∫–∞", you:"–í—ã", system:"–°–∏—Å—Ç–µ–º–∞", message:"–°–æ–æ–±—â–µ–Ω–∏–µ...", youJoined:"–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ", initiative:"–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞", changeAvatar:"–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä", changeUsername:"–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫", activeMember:"–ê–∫—Ç–∏–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫", statistics:"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", sound:"–ó–≤—É–∫", mainVolume:"–û—Å–Ω–æ–≤–Ω–æ–π –∑–≤—É–∫", effectsVolume:"–≠—Ñ—Ñ–µ–∫—Ç—ã", classicDnD:"–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π D&D", epic:"–≠–ø–∏—á–µ—Å–∫–∏–π", dark:"–¢—ë–º–Ω—ã–π", humorous:"–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π", rulesFirst:"–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π (rules-first)", attack:"–ê—Ç–∞–∫–æ–≤–∞—Ç—å", explore:"–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å", negotiate:"–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã", useItem:"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç", rollCube:"–ë—Ä–æ—Å–∏—Ç—å –∫—É–±", enterAction:"–í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ...", campaignStart:"–ù–∞—á–∞–ª–æ –∫–∞–º–ø–∞–Ω–∏–∏", diceRoll:"–ë—Ä–æ—Å–æ–∫ –∫—É–±–∞", primary:"–û—Å–Ω–æ–≤–Ω–æ–π", secondary:"–í—Ç–æ—Ä–∏—á–Ω—ã–π", background:"–§–æ–Ω", cyberpunk: "–ö–∏–±–µ—Ä–ø–∞–Ω–∫", forest: "–õ–µ—Å" },
      en: { newGame:"New Game", joinRoom:"Join Room", continue:"Continue", setPlot:"Set Plot", settings:"Settings", howToPlay:"How to Play", profile:"Profile", logout:"Logout", createRoom:"Create Room", joinByCode:"Join by Code", publicRooms:"Public Rooms", noSavedCampaigns:"No saved campaigns", startNewGame:"Start new game", campaignName:"Campaign Name", tone:"Narrative Tone", difficulty:"Difficulty", players:"Players", host:"Host", ready:"Ready", notReady:"Not Ready", startGame:"Start Game", saveCheckpoint:"Save Checkpoint", back:"Back", sceneDescription:"Scene Description", chat:"Chat", journal:"Journal", rollD20:"Roll d20", mute:"Mute", unmute:"Unmute", microphoneOn:"Microphone On", microphoneOff:"Microphone Off", themeSettings:"Themes", languageSettings:"Language", darkTheme:"Dark Theme", lightTheme:"Light Theme", customTheme:"Custom Theme", apply:"Apply", cancel:"Cancel", enterRoomCode:"Enter Room Code", join:"Join", public:"Public", private:"Private", campaignSettings:"Campaign Settings", gameReady:"Ready to start?", aiGenerating:"AI generating response...", login:"Login", register:"Register", email:"Email", password:"Password", confirmPassword:"Confirm Password", rememberMe:"Remember me", forgotPassword:"Forgot password?", createAccount:"Create account", alreadyHaveAccount:"Already have an account?", needAccount:"Need an account?", loginWith:"Login with", registerWith:"Register with", send:"Send", easy:"Easy", medium:"Medium", hard:"Hard", gamesPlayed:"Games Played", hoursPlayed:"Hours Played", achievements:"Achievements", recentCampaigns:"Recent Campaigns", welcomeBack:"Welcome back", createYourAccount:"Create your account", or:"or", rolled:"rolled", error:"Error", you:"You", system:"System", message:"Message...", youJoined:"You have joined the room", initiative:"Initiative", changeAvatar:"Change Avatar", changeUsername:"Change Nickname", activeMember:"Active member", statistics:"Statistics", sound:"Sound", mainVolume:"Main Volume", effectsVolume:"Effects Volume", classicDnD:"Classic D&D", epic:"Epic", dark:"Dark", humorous:"Humorous", rulesFirst:"Minimalistic (rules-first)", attack:"Attack", explore:"Explore", negotiate:"Negotiate", useItem:"Use Item", rollCube:"Roll Cube", enterAction:"Enter action...", campaignStart:"Campaign Start", diceRoll:"Dice Roll", primary:"Primary", secondary:"Secondary", background:"Background", cyberpunk: "Cyberpunk", forest: "Forest" }
    };
    const t = k => (translations[state.language] && translations[state.language][k]) || k;

    // ====== –¢–µ–º–∞ ======
    function applyTheme() {
      const theme = state.customTheme;
      document.documentElement.style.setProperty('--primary', theme.primary);
      document.documentElement.style.setProperty('--secondary', theme.secondary);
      document.documentElement.style.setProperty('--background', theme.background);
      document.documentElement.classList.toggle('dark', state.theme === 'dark');
    }
    function themePresets() { return [
        { name: t('darkTheme'), background: '#000000', primary: '#ff4500', secondary: '#8b0000' },
        { name: t('lightTheme'), background: '#f5f5f5', primary: '#d32f2f', secondary: '#b71c1c' },
        { name: t('cyberpunk'), background: '#0a0a12', primary: '#ff00ff', secondary: '#00ffff' },
        { name: t('forest'), background: '#0d1b0d', primary: '#4caf50', secondary: '#8bc34a' },
    ];}

    // ====== –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –†–µ–Ω–¥–µ—Ä ======
    function go(page) {
      // Clear any existing poll when we navigate away from a page
      if (state.pollingIntervalId) {
          clearInterval(state.pollingIntervalId);
          state.pollingIntervalId = null;
      }

      state.currentPage = page;
      render(); // This will now render the new page

      // If the new page is the lobby, start polling for updates
      if (page === 'lobby' && state.currentRoom?.room_code) {
          state.pollingIntervalId = setInterval(async () => {
              try {
                  const roomDetails = await api.getRoomDetails(state.currentRoom.room_code);
                  // Only re-render if the player list has actually changed
                  if (JSON.stringify(state.currentRoom.players) !== JSON.stringify(roomDetails.players)) {
                      state.currentRoom = roomDetails;
                      render();
                  }
              } catch (error) {
                  console.error("Lobby polling failed:", error);
                  clearInterval(state.pollingIntervalId);
                  state.pollingIntervalId = null;
              }
          }, 3000); // Poll every 3 seconds
      }
    }

    function render() {
      applyTheme();
      const root = qs('#app');
      root.innerHTML = (pages[state.currentPage] || pages.landing)();

      // Auto-scroll chat/scene boxes
      const sceneBox = qs('#sceneBox');
      if (sceneBox) sceneBox.scrollTop = sceneBox.scrollHeight;
      const chatBox = qs('#chatBox');
      if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ====== –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å API) ======
    async function handleStartCampaign(form) {
        const name = form.querySelector('textarea').value.trim();
        const tone = form.querySelector('#toneSelect').value;
        const difficulty = form.querySelector('input[name="difficulty"]:checked').value;
        if (!name) { alert('Please enter a campaign name/plot.'); return; }
        try {
            const newCampaign = await api.createCampaign(name, tone, difficulty);
            state.currentCampaign = newCampaign;
            const newRoom = await api.createRoom(true, newCampaign.name);
            state.currentRoom = newRoom;
            go('lobby');
        } catch (error) { alert(`${t('error')}: ${error.message}`); }
    }
    async function handleJoinRoom(roomId) {
        if (!state.user) return go('login');
        try {
            state.currentRoom = await api.joinRoom(roomId);
            go('lobby');
        } catch (error) { alert(`${t('error')}: ${error.message}`); }
    }
    async function handleLogin(form) {
        const email = form.email.value.trim(), password = form.password.value.trim();
        if (!email || !password) return;
        try {
            const { user_code, profile } = await api.login(email, password);
            storage.saveUserCode(user_code);
            state.user = profile;
            state.campaigns = await api.getCampaigns();
            go('landing');
        } catch (error) { alert(`${t('error')}: ${error.message}`); }
    }
    async function handleRegister(form) {
        const email = form.email.value.trim(), password = form.password.value.trim(), confirm = form.confirmPassword.value.trim();
        const username = email.split('@')[0];
        if (!email || !password || password !== confirm) { alert('Please fill all fields correctly.'); return; }
        try {
            const { user_code, profile } = await api.register(username, email, password);
            storage.saveUserCode(user_code);
            state.user = profile;
            go('landing');
        } catch (error) { alert(`${t('error')}: ${error.message}`); }
    }
    function handleLogout() {
      storage.removeUserCode();
      state.user = null;
      state.campaigns = [];
      go('landing');
    }
    function rollDice(sides, isPrivate = false) {
        state.isRolling = true; render();
        setTimeout(() => {
            const result = Math.floor(Math.random() * sides) + 1;
            state.diceRoll = { sides, result, isPrivate, timestamp: new Date().toLocaleTimeString(), player: state.user?.username || 'Player' };
            state.isRolling = false;
            if (!isPrivate) {
                state.chatMessages.push({ id: Date.now(), text: `${state.user?.username || 'Player'} ${t('rolled')} d${sides}: ${result}`, sender: 'system', timestamp: state.diceRoll.timestamp });
            }
            render();
        }, 1000);
    }
    async function sendAction(text) {
        const action = text.trim();
        if (!action) return;
        const userMessage = { role: 'user', content: action };
        state.chatMessages.push({ id: Date.now(), text: action, sender: state.user?.username || 'You', timestamp: new Date().toLocaleTimeString() });
        state.sceneHistory.push(userMessage);
        state.isRolling = true; render();
        try {
            if (!state.currentCampaign?.id) throw new Error("No active campaign found.");
            const messagesForApi = state.sceneHistory.map(h => ({ role: h.role, content: h.content }));
            const payload = {
                campaign_id: state.currentCampaign.id,
                messages: messagesForApi,
                language: state.language,
            };
            const aiResponse = await api.getAiCompletion(payload);
            const assistantMessage = { role: 'assistant', content: aiResponse.text };
            state.sceneHistory.push(assistantMessage);
            state.chatMessages.push({ id: Date.now(), text: aiResponse.text, sender: 'AI-–ú–∞—Å—Ç–µ—Ä', timestamp: new Date().toLocaleTimeString() });
            if (aiResponse.meta) { console.log("AI Metadata:", aiResponse.meta); }
        } catch (error) {
            const errorMessage = { role: 'system', content: `Error from AI: ${error.message}` };
            state.sceneHistory.push(errorMessage);
            state.chatMessages.push({ id: Date.now(), text: `Error: ${error.message}`, sender: 'System', timestamp: new Date().toLocaleTimeString() });
        } finally {
            state.isRolling = false; render();
        }
    }
    async function handleChangeAvatar() {
        const newAvatarUrl = prompt("Enter the URL for your new avatar:");
        if (newAvatarUrl && newAvatarUrl.trim() !== "") {
            try {
                state.user = await api.updateAvatar(newAvatarUrl.trim());
                render();
            } catch (error) { alert(`Error updating avatar: ${error.message}`); }
        }
    }
    async function handleChangeUsername() {
        const newUsername = prompt("Enter your new username:", state.user.username);
        if (newUsername && newUsername.trim() !== "") {
            try {
                state.user = await api.updateProfile(newUsername.trim());
                render();
            } catch (error) { alert(`Error updating username: ${error.message}`); }
        }
    }
    async function handleSelectCampaign(campaignId) {
        alert(`Continuing campaign ${campaignId}. This feature is partially implemented.`);
        // TODO: Fetch campaign details, set state.currentCampaign, create/join a room, then go('game').
    }
    async function handleDeleteCampaign(campaignId) {
        if (confirm(`Are you sure you want to delete campaign ${campaignId}? This cannot be undone.`)) {
            try {
                await api.deleteCampaign(campaignId);
                state.campaigns = await api.getCampaigns();
                render();
            } catch (error) { alert(`Error deleting campaign: ${error.message}`); }
        }
    }
    function toggleLobbyReady(button) {
      state.lobbyReady = !state.lobbyReady;
      const ready = state.lobbyReady;
      button.textContent = ready ? `${t('ready')} ‚úÖ` : t('notReady');
      button.className = `w-full py-3 rounded-lg font-semibold transition-all ${ready ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}`;
      const startBtn = qs('[data-action="start-game"]');
      if (startBtn) {
        startBtn.classList.toggle('opacity-50', !ready);
        startBtn.classList.toggle('cursor-not-allowed', !ready);
        startBtn.dataset.enabled = ready ? '1' : '0';
      }
    }

    // ====== –®–∞–±–ª–æ–Ω—ã —Å—Ç—Ä–∞–Ω–∏—Ü ======
    const pages = {
      login: () => `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="w-full max-w-md bg-black/50 rounded-xl p-8 border border-gray-800">
            <div class="text-center mb-8">
              <h2 class="text-2xl font-bold">${t('login')}</h2>
            </div>
            <form id="loginForm" class="space-y-4">
              <div><label class="block text-sm font-medium mb-1">${t('email')}</label><input type="email" name="email" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2" required /></div>
              <div><label class="block text-sm font-medium mb-1">${t('password')}</label><input type="password" name="password" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2" required /></div>
              <button type="submit" class="w-full bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] py-2 rounded-lg font-semibold">${t('login')}</button>
              <div class="text-center text-sm text-gray-400 mt-4">${t('needAccount')} <button type="button" data-action="go:register" class="text-[var(--primary)] font-medium">${t('register')}</button></div>
            </form>
          </div>
        </div>`,
      register: () => `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="w-full max-w-md bg-black/50 rounded-xl p-8 border border-gray-800">
            <h2 class="text-2xl font-bold text-center mb-8">${t('register')}</h2>
            <form id="registerForm" class="space-y-4">
              <div><label class="block text-sm font-medium mb-1">${t('email')}</label><input type="email" name="email" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2" required /></div>
              <div><label class="block text-sm font-medium mb-1">${t('password')}</label><input type="password" name="password" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2" required minlength="6" /></div>
              <div><label class="block text-sm font-medium mb-1">${t('confirmPassword')}</label><input type="password" name="confirmPassword" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2" required minlength="6" /></div>
              <button type="submit" class="w-full bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] py-2 rounded-lg font-semibold">${t('createAccount')}</button>
              <div class="text-center text-sm text-gray-400 mt-4">${t('alreadyHaveAccount')} <button type="button" data-action="go:login" class="text-[var(--primary)] font-medium">${t('login')}</button></div>
            </form>
          </div>
        </div>`,
      landing: () => {
        const authNav = !state.user
          ? `<button data-action="go:login" class="hover:text-[var(--primary)]">${t('login')}</button><button data-action="go:register" class="bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-4 py-2 rounded-lg">${t('register')}</button>`
          : `<button data-action="go:profile" class="hover:text-[var(--primary)]">${t('profile')}</button><button data-action="go:tutorial" class="hover:text-[var(--primary)]">${t('howToPlay')}</button><button data-action="go:settings" class="hover:text-[var(--primary)]">${t('settings')}</button><button data-action="logout" class="text-red-400 hover:text-red-300">${t('logout')}</button>`;
        return `
        <div class="min-h-screen relative overflow-hidden">
          <div class="relative z-10 container mx-auto px-6 py-12">
            <header class="flex justify-between items-center mb-20"><h1 class="text-3xl font-bold">Neuro D&D</h1><nav class="flex items-center space-x-6">${authNav}</nav></header>
            <div class="text-center mb-20">
              <h2 class="text-5xl md:text-7xl font-bold mb-6">${t('sceneDescription')} <span class="bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] bg-clip-text text-transparent">AI</span></h2>
              <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button data-action="go:new-game" class="bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-8 py-4 rounded-xl font-semibold text-lg">${t('newGame')}</button>
                <button data-action="go:join-room" class="border-2 border-[var(--primary)] hover:bg-[var(--primary)]/10 px-8 py-4 rounded-xl font-semibold text-lg">${t('joinRoom')}</button>
                <button data-action="continue" class="border-2 border-[var(--secondary)] hover:bg-[var(--secondary)]/10 px-8 py-4 rounded-xl font-semibold text-lg">${t('continue')}</button>
              </div>
            </div>
          </div>
        </div>`;
      },
      'new-game': () => `
        <div class="min-h-screen p-6"><div class="max-w-4xl mx-auto">
          <button data-action="go:landing" class="mb-8 flex items-center text-[var(--primary)]">‚Üê ${t('back')}</button>
          <h2 class="text-4xl font-bold mb-8">${t('newGame')}</h2>
          <form id="newGameForm"><div class="grid lg:grid-cols-2 gap-8">
            <div class="space-y-6"><div class="bg-black/50 p-6 rounded-xl border border-gray-800">
                <h3 class="text-xl font-semibold mb-4">${t('tone')}</h3>
                <select id="toneSelect" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                  <option value="epic_fantasy">${t('epic')}</option><option value="dark_fantasy">${t('dark')}</option><option value="humorous">${t('humorous')}</option>
                </select>
            </div><div class="bg-black/50 p-6 rounded-xl border border-gray-800">
                <h3 class="text-xl font-semibold mb-4">${t('difficulty')}</h3>
                <div class="space-y-2">
                  <label class="flex items-center"><input type="radio" name="difficulty" value="easy" class="mr-2"/> ${t('easy')}</label>
                  <label class="flex items-center"><input type="radio" name="difficulty" value="medium" class="mr-2" checked/> ${t('medium')}</label>
                  <label class="flex items-center"><input type="radio" name="difficulty" value="hard" class="mr-2"/> ${t('hard')}</label>
                </div>
            </div></div>
            <div class="bg-black/50 p-6 rounded-xl border border-gray-800">
              <h3 class="text-xl font-semibold mb-4">${t('setPlot')}</h3>
              <textarea placeholder="${t('campaignName')}" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 h-48 resize-none"></textarea>
            </div>
          </div><div class="mt-8 text-center">
            <button type="submit" class="bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-8 py-4 rounded-xl font-semibold text-lg">${t('createRoom')}</button>
          </div></form>
        </div></div>`,
      'join-room': () => `
        <div class="min-h-screen p-6"><div class="max-w-md mx-auto">
          <button data-action="go:landing" class="mb-8 flex items-center text-[var(--primary)]">‚Üê ${t('back')}</button>
          <h2 class="text-4xl font-bold mb-8">${t('joinRoom')}</h2>
          <div class="bg-black/50 p-8 rounded-xl border border-gray-800">
            <h3 class="text-2xl font-semibold mb-6">${t('enterRoomCode')}</h3>
            <div class="space-y-4">
              <input id="roomCode" type="text" placeholder="ABCD" maxlength="4" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-2xl text-center tracking-widest uppercase"/>
              <button data-action="join-room" class="w-full bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] py-3 rounded-lg font-semibold">${t('join')}</button>
            </div>
          </div>
        </div></div>`,
      'saved-campaigns': () => {
        const hasCampaigns = state.campaigns && state.campaigns.length > 0;
        return `
        <div class="min-h-screen p-6"><div class="max-w-6xl mx-auto">
          <button data-action="go:landing" class="mb-8 flex items-center text-[var(--primary)]">‚Üê ${t('back')}</button>
          <h2 class="text-4xl font-bold mb-8">${t('continue')}</h2>
          ${hasCampaigns ? `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${state.campaigns.map(c => `<div class="bg-black/50 p-6 rounded-xl border border-gray-800 flex flex-col justify-between">
                  <div><h3 class="text-xl font-bold text-[var(--primary)] truncate">${c.name}</h3>
                    <p class="text-sm text-gray-400 mt-2">Tone: ${t(c.tone)} | Difficulty: ${t(c.difficulty)}</p>
                  </div>
                  <div class="flex gap-2 mt-4">
                    <button data-action="select-campaign" data-id="${c.id}" class="flex-grow bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">${t('continue')}</button>
                    <button data-action="delete-campaign" data-id="${c.id}" class="bg-red-800 hover:bg-red-700 px-3 py-2 rounded-lg text-sm">üóëÔ∏è</button>
                  </div>
              </div>`).join('')}
            </div>` : `<div class="text-center py-16">
              <h3 class="text-2xl font-semibold mb-2">${t('noSavedCampaigns')}</h3>
              <button data-action="go:new-game" class="bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-8 py-3 rounded-lg font-semibold mt-4">${t('newGame')}</button>
            </div>`}
        </div></div>`;
      },
      lobby: () => {
        const room = state.currentRoom;
        if (!room) return `<div class="p-8">Loading room...</div>`;
        const isHost = room.host_user_code === state.user?.user_code;
        return `
        <div class="min-h-screen p-6"><div class="container mx-auto">
          <button data-action="go:landing" class="mb-6 flex items-center text-[var(--primary)]">‚Üê ${t('back')}</button>
          <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-black/50 rounded-xl p-6 border border-gray-800 self-start">
              <h3 class="text-2xl font-semibold mb-6">${t('players')} (${room.players.length}/4)</h3>
              <div class="space-y-4 mb-6">
                ${room.players.map(p => `<div class="p-4 bg-gray-800/50 rounded-lg flex items-center justify-between">
                    <div><p class="font-semibold">${p.user_code === state.user.user_code ? t('you') : p.username}</p>
                         <span class="text-xs text-purple-400">${p.user_code === room.host_user_code ? t('host') : ''}</span></div>
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                </div>`).join('')}
              </div>
              <button data-action="toggle-ready" class="w-full py-3 rounded-lg font-semibold transition-all ${state.lobbyReady ? 'bg-green-600' : 'bg-gray-600'}">${state.lobbyReady ? t('ready') + ' ‚úÖ' : t('notReady')}</button>
            </div>
            <div class="lg:col-span-2 space-y-8">
              <div class="bg-black/50 rounded-xl p-8 border border-gray-800">
                <h2 class="text-3xl font-bold mb-2">${room.name}</h2>
                <p class="text-gray-400">Room Code: <span class="font-mono bg-gray-800 px-2 py-1 rounded">${room.room_code}</span></p>
              </div>
              ${isHost ? `<div class="flex justify-end">
                <button data-action="start-game" data-enabled="0" class="px-8 py-3 bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] rounded-lg font-semibold transition-all opacity-50 cursor-not-allowed">${t('startGame')}</button>
              </div>` : `<div class="text-center p-4 bg-gray-800 rounded-lg">Waiting for host to start the game...</div>`}
            </div>
          </div>
        </div></div>`;
      },
      game: () => `
        <div class="min-h-screen relative"><div class="container mx-auto px-6 py-4">
          <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
              <button data-action="go:lobby" class="text-[var(--primary)]">‚Üê ${t('back')}</button>
              <h1 class="text-2xl font-bold">${state.currentRoom?.name || t('campaignName')}</h1>
            </div>
            <div class="flex items-center space-x-4">
              <button data-action="toggle-mute" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-800" title="${t('mute')}">${state.isMuted ? 'üîá' : 'üîä'}</button>
              <button data-action="open-settings" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-800" title="${t('settings')}">‚öôÔ∏è</button>
            </div>
          </div>
          <div class="grid lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3 space-y-6">
              <div class="bg-black/50 rounded-xl overflow-hidden border border-gray-800 h-[70vh] flex flex-col">
                <div id="sceneBox" class="p-6 flex-grow overflow-y-auto">
                  ${state.sceneHistory.length === 0 ? `<div class="text-center text-gray-500">${t('sceneDescription')}</div>` :
                    state.sceneHistory.map(scene => `<div class="mb-4 ${scene.role === 'assistant' ? 'text-orange-300' : ''}">${scene.content}</div>`).join('')}
                  ${state.isRolling ? `<div class="text-sm text-[var(--primary)] animate-pulse">${t('aiGenerating')}</div>` : ''}
                </div>
              </div>
              <div class="bg-black/50 rounded-xl p-4 border border-gray-800">
                <div class="flex items-center space-x-2">
                  <input id="gameInput" type="text" placeholder="${t('enterAction')}" class="flex-1 bg-gray-800 border-gray-700 rounded-lg px-4 py-3">
                  <button data-action="send-game-action" class="bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-6 py-3 rounded-lg font-semibold">${t('send')}</button>
                </div>
              </div>
            </div>
            <div class="lg:col-span-1 space-y-6">
              <div class="bg-black/50 rounded-xl border border-gray-800 h-[80vh] flex flex-col">
                <div class="p-4 border-b border-gray-800"><h3 class="text-xl font-semibold">${t('chat')}</h3></div>
                <div id="chatBox" class="p-4 flex-grow overflow-y-auto text-sm space-y-3">
                  ${state.chatMessages.map(msg => `<div class="${msg.sender === 'system' ? 'text-[var(--primary)] italic' : ''}">
                      ${msg.sender !== 'system' ? `<div class="font-semibold text-[var(--primary)]">${msg.sender}</div>` : ''}
                      <div>${msg.text}</div><div class="text-xs text-gray-500">${msg.timestamp}</div>
                    </div>`).join('')}
                </div>
                <div class="p-4 border-t border-gray-800">
                  <div class="flex gap-2"><input id="chatInput" type="text" placeholder="${t('message')}" class="flex-1 bg-gray-800 rounded-lg px-3 py-2 text-sm"><button data-action="send-chat-msg" class="bg-[var(--primary)] px-3 py-2 rounded-lg text-sm">‚Üµ</button></div>
                </div>
              </div>
            </div>
          </div>
        </div></div>`,
      settings: () => {
        const presets = themePresets();
        return `
        <div class="min-h-screen p-6"><div class="max-w-4xl mx-auto">
          <button data-action="go:landing" class="mb-8 flex items-center text-[var(--primary)]">‚Üê ${t('back')}</button>
          <h2 class="text-4xl font-bold mb-8">${t('settings')}</h2>
          <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-black/50 p-6 rounded-xl border border-gray-800">
              <h3 class="text-2xl font-semibold mb-4">${t('languageSettings')}</h3>
              <div class="space-y-3">
                <label class="flex items-center p-3 bg-gray-800/50 rounded-lg"><input type="radio" name="language" value="ru" class="mr-3 w-5 h-5" ${state.language === 'ru' ? 'checked' : ''}><span class="text-lg">–†—É—Å—Å–∫–∏–π</span></label>
                <label class="flex items-center p-3 bg-gray-800/50 rounded-lg"><input type="radio" name="language" value="en" class="mr-3 w-5 h-5" ${state.language === 'en' ? 'checked' : ''}><span class="text-lg">English</span></label>
              </div>
            </div>
            <div class="bg-black/50 p-6 rounded-xl border border-gray-800">
              <h3 class="text-2xl font-semibold mb-4">${t('themeSettings')}</h3>
              <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  ${presets.map((p, i) => `<button data-action="set-theme-preset:${i}" class="p-4 rounded-lg border border-gray-700 text-left">
                      <div class="font-semibold">${p.name}</div>
                      <div class="h-2 rounded mt-2" style="background:linear-gradient(to right, ${p.primary}, ${p.secondary})"></div>
                    </button>`).join('')}
                </div>
                <div class="mt-6 p-4 bg-gray-800/50 rounded-lg">
                  <h4 class="font-semibold mb-3">${t('customTheme')}</h4>
                  <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm mb-1">${t('primary')}</label><input id="cPrimary" type="color" value="${state.customTheme.primary}" class="w-full h-10"></div>
                    <div><label class="block text-sm mb-1">${t('secondary')}</label><input id="cSecondary" type="color" value="${state.customTheme.secondary}" class="w-full h-10"></div>
                    <div><label class="block text-sm mb-1">${t('background')}</label><input id="cBackground" type="color" value="${state.customTheme.background}" class="w-full h-10"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div></div>`;
      },
      profile: () => {
        const avatar = state.user?.avatar_url
            ? `<img src="${state.user.avatar_url}" alt="Avatar" class="w-32 h-32 rounded-full object-cover mx-auto mb-4">`
            : `<div class="w-32 h-32 bg-gradient-to-br from-[var(--primary)] to-[var(--secondary)] rounded-full mx-auto mb-4 flex items-center justify-center text-4xl">${state.user?.username?.charAt(0).toUpperCase() || 'P'}</div>`;
        return `
        <div class="min-h-screen p-6"><div class="max-w-4xl mx-auto">
          <button data-action="go:landing" class="mb-8 flex items-center text-[var(--primary)]">‚Üê ${t('back')}</button>
          <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-black/50 rounded-xl p-6 border border-gray-800 text-center self-start">
              ${avatar}
              <h2 class="text-2xl font-bold mb-2">${state.user?.username || 'Player'}</h2>
              <p class="text-gray-400 mb-6">${t('activeMember')}</p>
              <div class="space-y-3">
                <button data-action="change-avatar" class="w-full bg-gray-800 hover:bg-gray-700 py-2 rounded-lg">${t('changeAvatar')}</button>
                <button data-action="change-username" class="w-full bg-gray-800 hover:bg-gray-700 py-2 rounded-lg">${t('changeUsername')}</button>
              </div>
            </div>
            <div class="lg:col-span-2 space-y-6">
              <div class="bg-black/50 rounded-xl p-6 border border-gray-800"><h3 class="text-2xl font-semibold mb-6">${t('statistics')}</h3></div>
              <div class="bg-black/50 rounded-xl p-6 border border-gray-800"><h3 class="text-2xl font-semibold mb-6">${t('recentCampaigns')}</h3><div class="text-center py-8 text-gray-500">${t('noSavedCampaigns')}</div></div>
            </div>
          </div>
        </div></div>`;
      },
      tutorial: () => `
        <div class="min-h-screen p-6"><div class="max-w-4xl mx-auto">
          <button data-action="go:landing" class="mb-8 flex items-center text-[var(--primary)]">‚Üê ${t('back')}</button>
          <h2 class="text-4xl font-bold mb-8 text-center">${t('howToPlay')}</h2>
        </div></div>`,
    };

    // ====== –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) ======
    function setupEventListeners() {
      const app = qs('#app');
      if (app.dataset.listenersAttached) return;

      app.addEventListener('click', async (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const [type, value] = action.split(':');

        switch (type) {
          case 'go': go(value); break;
          case 'logout': handleLogout(); break;
          case 'continue':
            if (!state.user) return go('login');
            if (state.campaigns && state.campaigns.length > 0) go('saved-campaigns');
            else go('new-game');
            break;
          case 'join-room':
            const code = qs('#roomCode')?.value.trim().toUpperCase();
            if(code) handleJoinRoom(code);
            break;
          case 'select-campaign': await handleSelectCampaign(target.dataset.id); break;
          case 'delete-campaign': await handleDeleteCampaign(target.dataset.id); break;
          case 'toggle-ready': toggleLobbyReady(target); break;
          case 'start-game': if (target.dataset.enabled === '1') go('game'); break;
          case 'send-game-action':
            const gameInput = qs('#gameInput');
            if (gameInput?.value) { sendAction(gameInput.value); gameInput.value = ''; }
            break;
          case 'send-chat-msg':
            const chatInput = qs('#chatInput');
            // Implement chat logic here
            if (chatInput?.value) { console.log("Chat:", chatInput.value); chatInput.value = ''; }
            break;
          case 'toggle-mute': state.isMuted = !state.isMuted; render(); break;
          case 'open-settings': openSettingsModal(); break;
          case 'change-avatar': await handleChangeAvatar(); break;
          case 'change-username': await handleChangeUsername(); break;
          case 'set-theme-preset':
            const p = themePresets()[+value];
            if (p) {
              state.theme = (p.name === t('lightTheme')) ? 'light' : 'dark';
              state.customTheme = { primary: p.primary, secondary: p.secondary, background: p.background };
              localStorage.setItem('theme', state.theme);
              localStorage.setItem('customTheme', JSON.stringify(state.customTheme));
              await api.saveSettings({ theme: state.theme, language: state.language });
              render();
            }
            break;
        }
      });

      app.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        switch (form.id) {
          case 'loginForm': handleLogin(form); break;
          case 'registerForm': handleRegister(form); break;
          case 'newGameForm': handleStartCampaign(form); break;
        }
      });

      app.addEventListener('input', async (e) => {
          const input = e.target;
          if (input.type !== 'color') return;
          const themeKey = input.id.replace('c', '').toLowerCase(); // cPrimary -> primary
          if (state.customTheme.hasOwnProperty(themeKey)) {
              state.customTheme[themeKey] = input.value;
              applyTheme();
              // Debounce in a real app
              localStorage.setItem('customTheme', JSON.stringify(state.customTheme));
              await api.saveSettings({ theme: state.theme, language: state.language });
          }
      });

      app.addEventListener('change', async (e) => {
        if (e.target.name === 'language') {
          state.language = e.target.value;
          localStorage.setItem('language', state.language);
          await api.saveSettings({ theme: state.theme, language: state.language });
          render();
        }
      });

      app.dataset.listenersAttached = 'true';
    }

    // ====== –ú–æ–¥–∞–ª–∫–∏ ======
    function openSettingsModal() {
        // Since modals are outside #app, they need their own listeners or be put inside.
        // For now, let's just re-render the settings page
        go('settings');
    }

    // ====== –°—Ç–∞—Ä—Ç ======
    async function init() {
      const savedLang = localStorage.getItem('language');
      const savedTheme = localStorage.getItem('theme');
      const savedCustomTheme = localStorage.getItem('customTheme');
      if (savedLang) state.language = savedLang;
      if (savedTheme) state.theme = savedTheme;
      if (savedCustomTheme) {
        try { state.customTheme = JSON.parse(savedCustomTheme); }
        catch (e) { console.error("Could not parse custom theme", e); }
      }

      setupEventListeners(); // Attach global listeners ONCE.

      const userCode = storage.getUserCode();
      if (userCode) {
        try {
          state.user = await api.getMe();
          state.campaigns = await api.getCampaigns();
          go('landing');
        } catch (error) {
          storage.removeUserCode();
          state.user = null;
          go('login');
        }
      } else {
        go('login');
      }
    }

    init();
  </script>
</body>
</html>
